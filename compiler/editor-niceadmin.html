<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="{% static 'codemirror/codemirror-5.57.0/lib/codemirror.css' %}">
    <link rel="stylesheet" href="{% static 'codemirror/codemirror-5.57.0/theme/3024-night.css' %}">
    <link rel="stylesheet" href="{% static 'codemirror/codemirror-5.57.0/addon/display/fullscreen.css' %}">
    <link rel="stylesheet" href="{% static 'codemirror/codemirror-5.57.0/addon/fold/foldgutter.css' %}" />
    <link rel="stylesheet" href="{% static 'codemirror/codemirror-5.57.0/addon/hint/show-hint.css' %}" />
    <link rel="stylesheet" href="{% static 'codemirror/codemirror-5.57.0/addon/lint/lint.css' %}" />
    <link rel="stylesheet" href="{% static 'codemirror/codemirror-5.57.0/addon/dialog/dialog.css' %}" />
    <link rel="stylesheet" href="{% static 'codemirror/codemirror-5.57.0/addon/search/matchesonscrollbar.css' %}" />
    <!---->
    <script src="{% static 'codemirror/codemirror-5.57.0/lib/codemirror.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/lib/util/formatting.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/hint/show-hint.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/hint/xml-hint.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/hint/html-hint.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/hint/javascript-hint.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/hint/css-hint.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/lint/lint.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/lint/html-lint.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/lint/javascript-lint.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/lint/css-lint.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/mode/htmlmixed/htmlmixed.js' %}"></script>

    <script src="{% static 'codemirror/codemirror-5.57.0/addon/dialog/dialog.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/search/searchcursor.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/search/search.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/scroll/annotatescrollbar.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/search/matchesonscrollbar.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/search/jump-to-line.js' %}"></script>

    <script src="{% static 'codemirror/codemirror-5.57.0/mode/javascript/javascript.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/selection/active-line.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/edit/matchbrackets.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/mode/css/css.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/fold/foldcode.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/fold/foldgutter.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/fold/brace-fold.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/fold/xml-fold.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/fold/indent-fold.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/fold/markdown-fold.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/fold/comment-fold.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/mode/xml/xml.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/scroll/simplescrollbars.js' %}"></script>
    <script src="{% static 'codemirror/codemirror-5.57.0/addon/display/fullscreen.js' %}"></script>
    <!--
    -->

    <style>
        #preview {
            /*position: fixed;
            width: 50vw;
            height: 30vh;*/
        }

        #editingform {
            /*display: grid;*/
        }

        iframe.modal-display {
            position: absolute;
            width: 60vw;
            height: 60vh;
            z-index: 2;
            background-color: aliceblue;
            top: 20%;
            left: 20%;
        }

        /*.CodeMirror {
            height: 50vh;
        }
        body {
            background-color: gray;
        }*/
    </style>
</head>
<body>
    <a href="javascript:autoFormatSelection()">Autoformat Selected</a>
    <a href="javascript:blowUpPreview()">Preview Page</a>
    <iframe id=preview></iframe>
    <select name="page-select" id="page-select"></select>
    <form id="editingform" method="POST" style="margin-top: 150px;"> {% csrf_token %}
        {{ form }}
        <input type="submit" value="Save" />
    </form>
    <script>
        /*console.log(document.querySelector("table.pages-array-model-field"));
        let areas = document.querySelectorAll("textarea");
        let pages = document.querySelector("table.pages-array-model-field");
        for (i=0; i < 2; i++){
            const editor = CodeMirror.fromTextArea(document.getElementById(`${pages.children[i].children[8].children[1].children[0].id}`), {
                lineNumbers: true,
                mode: "text/html",
                matchBrackets: true,
                lineWrapping: true,
                theme: "3024-night",
                extraKeys: {
                    "Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); },
                    "F11": function(cm) {
                        cm.setOption("fullScreen", !cm.getOption("fullScreen"));
                    },
                    "Esc": function(cm) {
                        if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
                    }
                },
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                scrollbarStyle: "simple"
            });
        }*/
    </script>
    <script>
        let delay;
        let areas = document.querySelectorAll("textarea");
        let pages = document.querySelector("table.pages-array-model-field");
        let pageSelect = document.querySelector("#page-select");
        let shortCodes = document.querySelector("table.shortcodes-array-model-field");
        shortCodes.style = "display: none";
        for (i=0; i < pages.children.length; i++){
            page = pages.children[i];
            let pageOpt = document.createElement("option");
            pageOpt.value = `${i}`;
            pageOpt.text = `${i}: ${page.children[0].children[1].children[0].value}`;
            pageSelect.append(pageOpt);
        }
        pageSelect.addEventListener("change", (e)=> {
            pageId = `#id_pages-${e.target.value}-content`;
            for (i=0; i < pages.children.length; i++){
                page = pages.children[i];
                page.style = "display: none";
            }
            for (i=0; i < pages.children.length; i++){
                page = pages.children[i];
                if(i == e.target.value){
                    page.style = "";
                }
                page.children[8].scrollIntoView();
                page.children[8].children[1].children[0].focus();
            }
        })
        for (i=0; i < areas.length; i++){
            areas[i].rows = 5;
            areas[i].addEventListener("focusin", (e)=> {
                let editor = CodeMirror.fromTextArea(e.target, {
                    lineNumbers: true,
                    styleActiveLine: true,
                    mode: "htmlmixed",
                    theme: "3024-night",
                    matchBrackets: true,
                    lineWrapping: true,
                    extraKeys: {
                        "F11": function(cm) {
                            cm.setOption("fullScreen", !cm.getOption("fullScreen"));
                        },
                        "Esc": function(cm) {
                            if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
                        },
                        "Ctrl-Space": "autocomplete",
                        "Alt-F": "findPersistent"
                    },
                    gutters: ["CodeMirror-linenumbers"],
                });

                CodeMirror.commands["selectAll"](editor);

                function getSelectedRange() {
                    return { from: editor.getCursor(true), to: editor.getCursor(false) };
                }
                
                function autoFormatSelection() {
                    var range = getSelectedRange();
                    editor.autoFormatRange(range.from, range.to);
                }
                
                function commentSelection(isComment) {
                    var range = getSelectedRange();
                    editor.commentRange(isComment, range.from, range.to);
                }
                
                autoFormatSelection();

                editor.setSelection(editor.getCursor("start"))
                editor.on("change", ()=>{
                    editor.save();
                    clearTimeout(delay);
                    delay = setTimeout(()=>{
                        var previewFrame = document.getElementById('preview');
                        var preview =  previewFrame.contentDocument ||  previewFrame.contentWindow.document;
                        preview.open();
                        preview.write(editor.getValue());
                        preview.close();
                    }, 300)

                })

                editor.on("blur", ()=>{
                    clearTimeout(delay)
                    delay = setTimeout(()=>{
                        if(!editor.hasFocus()){
                            editor.toTextArea();
                        }
                    }, 10000)
                    
                })

                
            })
            
        }

        function blowUpPreview(){
            var prevFrame = document.getElementById('preview');
            prevFrame.classList.toggle("modal-display");
        }

        
        
            
            
    </script>
</body>
</html>